# Transform：订单表格结构化与数据清洗（PDF/图片）

## 1. 功能简介

本模块负责读取上游提取（Extract）阶段输出的 Parquet（订单表格数据），对订单明细进行**结构化清洗与字段标准化**，并自动修正因 OCR 或原文噪声导致的错行、多值、缺漏等问题。处理逻辑会根据输入的是 PDF 还是图片数据采用不同的规则和分流，并利用 LLM 做补全和异常纠偏。

适用于 n8n 自动化场景下多来源订单/发票表单的标准 ETL 中 “Transform” 阶段。

---

## 2. 输入数据约定

- **Content-Type:** `application/json`
- **参数示例**
  ```json
  {
    "filepath": "./tmp/[extract生成].parquet"
  }
  ```

---

## 3. 流程分支与处理逻辑

### 1) PDF 转换流程（接口 `/pdf_transform`）

- **处理步骤与主要逻辑**：
  1. 读取 parquet 文件与 embedded 元数据（如订单号、日期、客户等 meta 字段）。
  2. 调用 `transform_pipeline_pdf()` 进行：
      - **表头标准化**（中英文/繁简自动映射到标准字段）
      - **多值行拆分**
      - **错位纠偏**（自动检测字段错位，采用 LLM 智能重分配或补全）
      - **缺失填补**（通过 LLM 填补缺少的数量/品号等字段）
      - **金额、数量等数据类型还原为 float**
      - **全表过滤与类型二次转换**（排除异常，确保可直入库/分析）
  3. 输出“已清洗标准化数据表”+ 订单头 meta 信息

- **API定义**
  - 路径：`/pdf_transform`
  - 请求Body：
    ```json
    {
      "filepath": "./tmp/invoice001_extract.parquet"
    }
    ```
  - 返回示例：
    ```json
    {
      "orderinfo": { "订单号": "...", "日期": "...", "买方": "...", ...},
      "data": [
        {"品名": "...", "品號": "...", "price": 123.0, "quantity": 5.0},
        ...
      ]
    }
    ```

---

### 2) 图片转换流程（接口 `/img_transform`）

- **处理步骤与主要逻辑**：
  1. 读取图片 OCR 输出所得 Parquet 文件（无 meta 头）。
  2. 调用 `transform_pipeline_img()` 进行：
      - **表头标准化**
      - **整列文本 LLM 强制结构化**（如“品名+编号+数量”合在一列抽出来）
      - **金额、数量数据转 float/int**
      - **全表applymap二次智能转换**（类型/空值处理）
      - **输出结构化表格数据**

- **API定义**
  - 路径：`/img_transform`
  - 请求Body：
    ```json
    {
      "filepath": "./tmp/photo001_extract.parquet"
    }
    ```
  - 返回示例：
    ```json
    {
      "orderinfo": {},
      "data": [
        {"品名": "...", "品號": "...", "price": 123.0, "quantity": 5.0},
        ...
      ]
    }
    ```

### 3) 模糊比对（接口 `/fuzzy`）

- **流程**：
  1. 读入标准品名库
  2. 可为本地 Excel/CSV，或通过 API 动态维护（需有“品名”“品號”等标准字段）
  3. 对提取表格的品名列进行模糊比对
  4. 支持中文、英文、替换词、简繁体混排
  5. 为每条数据返回 “最优匹配品名”“比对分数”“是否低于阈值、需人工复核”等信息

---

## 4. 适用场景

- 结构性较好订单 PDF：表格字段对齐、元信息齐全，自动还原+纠偏高效
- 拍照等结构弱图片：采用 LLM 对自由文本强行重组表格，大幅提升可用性
- 兼容繁简/中英文混排、行内多商品、错位/缺失、金额文本噪声等实际商用票据场景

---

## 5. 依赖环境

- Python >= 3.11
- pandas, fastapi, pyarrow
- 需下载并配置 Ollama
